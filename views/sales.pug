extends layout

block navbar
  nav.navbar.navbar-expand-lg.navbar-dark.bg-dark.py-2
    .container-fluid
      a.navbar-brand(href='/dashboard') MWF
      button.navbar-toggler(type='button', data-bs-toggle='collapse', data-bs-target='#navbarNav', aria-controls='navbarNav', aria-expanded='false', aria-label='Toggle navigation')
        span.navbar-toggler-icon
      #navbarNav.collapse.navbar-collapse.justify-content-end
        ul.navbar-nav.ms-auto
          li.nav-item
            a.nav-link(href='/dashboard') Dashboard
          li.nav-item
            a.nav-link.active(href='/sales') Sales
          li.nav-item
            a.nav-link(href='/saleslist') Saleslist
          li.nav-item
            a.nav-link(href='/salesRecords') SalesRecords
          li.nav-item
            a.nav-link.text-danger(href='/logout') Logout

block content
  .container.mt-5
    .row.justify-content-center
      .col-md-8.col-lg-7
        .card.shadow-lg.p-4(style="background-color:#DEB887; border-radius:10px;")
          h2.text-center.mb-4 Record a Sale
          hr
          form#addSaleForm(action='/sales' method='post')
            .row.mb-3
              .col-md-6
                label.form-label Customer Name
                input.form-control(type='text' required name='customerName')
              .col-md-6
                label.form-label Date
                input.form-control(type='date' required name='date')

            .row.mb-3
              .col-md-6
                label.form-label Product Type
                select#productType.form-select(name='productType' required)
                  option(value='') Select Type
                  option(value='wood') Wood
                  option(value='furniture') Furniture
              .col-md-6
                label.form-label Product Name
                select#productName.form-select(name='productName' required)
                  option(value='') Choose Product
                  // ✅ Dynamically show stock with quantity
                  if stocks && stocks.length
                    each stock in stocks
                      option(
                        value=stock.productName 
                        data-type=stock.productType
                      ) #{stock.productName} (#{stock.quantity} available)
                  else
                    option(disabled selected) No stock available

            .row.mb-3
              .col-md-6
                label.form-label Quantity
                input#quantity.form-control(type='number' min='1' required name='quantity')
              .col-md-6
                label.form-label Include Transport (5%)
                select#transport.form-select(name='transport' required)
                  option(value='') Choose
                  option(value='Yes') Yes
                  option(value='No') No

            .row.mb-3
              .col-md-6
                label.form-label Payment Type
                select.form-select(name='paymentType' required)
                  option(value='') Choose
                  option(value='cash') Cash
                  option(value='cheque') Cheque
                  option(value='bankOverdraft') Bank Overdraft
              .col-md-6
                label.form-label Sales Agent
                input.form-control(type='text' required name='salesAgent')

            .row.mb-3
              .col-md-6
                label.form-label Selling Price per Unit (UGX)
                input#sellingPrice.form-control(type='number' min='1' required name='sellingPrice')
              .col-md-6
                label.form-label Total Amount (UGX)
                input#totalAmount.form-control(type='number' name='totalAmount' readonly style='background-color:#f8f9fa; font-weight:bold;')

            .d-grid
              button.btn.btn-dark(type='submit') Submit Sale

  // JS
  script.
    document.addEventListener('DOMContentLoaded', function () {
      const quantityInput = document.getElementById('quantity');
      const priceInput = document.getElementById('sellingPrice');
      const transportSelect = document.getElementById('transport');
      const totalInput = document.getElementById('totalAmount');
      const productTypeSelect = document.getElementById('productType');
      const productNameSelect = document.getElementById('productName');

      // ✅ Filter product list based on type
      productTypeSelect.addEventListener('change', () => {
        const selectedType = productTypeSelect.value;
        const options = productNameSelect.querySelectorAll('option[data-type]');
        productNameSelect.value = '';
        options.forEach(opt => {
          opt.hidden = selectedType && opt.dataset.type !== selectedType;
        });
      });

      // ✅ Auto-calculate total
      function calculateTotal() {
        const qty = parseFloat(quantityInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const baseTotal = qty * price;
        let finalTotal = baseTotal;

        if (transportSelect.value === 'Yes') {
          finalTotal = baseTotal * 1.05;
        }

        totalInput.value = finalTotal.toFixed(2);
      }

      quantityInput.addEventListener('input', calculateTotal);
      priceInput.addEventListener('input', calculateTotal);
      transportSelect.addEventListener('change', calculateTotal);
    });
