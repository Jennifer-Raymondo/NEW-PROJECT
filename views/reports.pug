//- doctype html
//- html
//-   head
//-     meta(charset="UTF-8")
//-     meta(name="viewport" content="width=device-width, initial-scale=1.0")
//-     title Reports - MWF
//-     link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet")
//-     link(href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet")
//-     link(rel='stylesheet' href='/css/style.css')
//-     style.
//-       body {
//-         background-color: burlywood;
//-         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
//-       }
//-       .navbar-brand {
//-         font-weight: bold;
//-       }
//-       .card {
//-         background-color: burlywood;
//-         color: #4e342e;
//-         border-radius: 1rem;
//-         padding: 1.5rem;
//-         box-shadow: 0 4px 12px rgba(0,0,0,0.08);
//-       }
//-       .form-control, .form-select {
//-         border-radius: 0.5rem;
//-         height: 38px;
//-         margin-bottom: 10px;
//-       }
//-       .btn-primary, .btn-danger {
//-         border-radius: 0.5rem;
//-         font-size: 0.9rem;
//-         padding: 0.35rem 0;
//-       }
//-       .btn.btn-primary {
//-         background:black;
//-         color:white;
//-       }
//-       .btn.btn-danger#generatePDF {
//-         background:black;
//-         color:white;
//-       }
//-       .text-center{
//-         color: white;
//-       }

//-   body
//-     // Navbar
//-     nav.navbar.navbar-expand-lg.navbar-dark.bg-dark
//-       .container-fluid
//-         a.navbar-brand(href='/dashboard') MWF Dashboard
//-         button.navbar-toggler(type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav")
//-           span.navbar-toggler-icon
//-         #navbarNav.collapse.navbar-collapse.justify-content-end
//-           ul.navbar-nav
//-             li.nav-item
//-               a.nav-link(href='/dashboard') Dashboard
//-             li.nav-item
//-               a.nav-link(href='/saleslist') Saleslist
//-             li.nav-item
//-               a.nav-link(href='/salesRecords') SalesRecords
//-             li.nav-item
//-               a.nav-link.active(href='/reports') Reports
//-             li.nav-item
//-               a.nav-link.text-danger(href='/logout') Log out

//-     // Page Content
//-     .container.my-5
//-       .row.justify-content-center
//-         .col-md-8
//-           .card
//-             h4.text-center.mb-4 Generate Reports

//-             // Filter Form
//-             form#reportFilterForm(method='GET', action='/reports/generate')
//-               label.form-label(for='reportType') Report Type
//-               select.form-select(name='reportType', required)
//-                 option(value='sales' selected=(reportType==='sales')) Sales
//-                 option(value='stock' selected=(reportType==='stock')) Stock

//-               label.form-label(for='fromDate') From
//-               input.form-control(type='date', name='fromDate', required value=fromDate)

//-               label.form-label(for='toDate') To
//-               input.form-control(type='date', name='toDate', required value=toDate)

//-               label.form-label(for='period') Period
//-               select.form-select(name='period', required)
//-                 option(value='daily' selected=(period==='daily')) Daily
//-                 option(value='weekly' selected=(period==='weekly')) Weekly
//-                 option(value='monthly' selected=(period==='monthly')) Monthly
//-                 option(value='yearly' selected=(period==='yearly')) Yearly

//-               .d-flex.flex-column.gap-2.mt-3
//-                 button.btn.btn-primary(type='submit') Generate
//-                 button.btn.btn-danger#generatePDF(type='button') Download PDF

//-             if salesData && salesData.length
//-               .mt-4
//-                 h5.text-center Report Results
//-                 table#reportTable.table.table-bordered.table-striped
//-                   thead
//-                     tr
//-                       th Date / Period
//-                       if reportType === 'sales'
//-                         th Total Sales
//-                         th Quantity Sold
//-                       else
//-                         th Total Stock Value
//-                         th Quantity in Stock
//-                   tbody
//-                     each record in salesData
//-                       tr
//-                         td= record._id
//-                         if reportType === 'sales'
//-                           td= record.totalSales
//-                           td= record.totalQuantity
//-                         else
//-                           td= record.totalStockValue
//-                           td= record.totalQuantity

//-               h5.mt-3.text-end Grand Total: #{totalSales} Shs

//-     // Scripts
//-     script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
//-     script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
//-     script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js")
//-     script.
//-       const { jsPDF } = window.jspdf;
//-       document.getElementById('generatePDF').addEventListener('click', () => {
//-         const doc = new jsPDF();
//-         doc.setFontSize(18);
//-         doc.text("MWF Report", 20, 20);
//-         const table = document.getElementById('reportTable');
//-         if (table) {
//-           doc.autoTable({ html: table, startY: 30 });
//-         }
//-         const totalSales = !{totalSales || 0};
//-         doc.setFontSize(14);
//-         doc.text(`Grand Total: ${totalSales} Shs`, 20, doc.lastAutoTable.finalY + 10);
//-         doc.save("MWF_Report.pdf");
//-       });



doctype html
html
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Reports - MWF
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet")
    link(href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet")
    link(rel='stylesheet' href='/css/style.css')
    style.
      body {
        background-color: burlywood;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .navbar-brand {
        font-weight: bold;
      }
      .card {
        background-color: burlywood;
        color: #4e342e;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .form-control, .form-select {
        border-radius: 0.5rem;
        height: 38px;
        margin-bottom: 10px;
      }
      .btn-primary, .btn-danger {
        border-radius: 0.5rem;
        font-size: 0.9rem;
        padding: 0.35rem 0;
      }
      .btn.btn-primary {
        background:black;
        color:white;
      }
      .btn.btn-danger#generatePDF {
        background:black;
        color:white;
      }
      .text-center{
        color: white;
      }
      .summary-card {
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        margin-bottom: 1rem;
      }
      .table-responsive {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1rem;
      }

  body
    nav.navbar.navbar-expand-lg.navbar-dark.bg-dark
      .container-fluid
        a.navbar-brand(href='/dashboard') MWF Dashboard
        button.navbar-toggler(type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav")
          span.navbar-toggler-icon
        #navbarNav.collapse.navbar-collapse.justify-content-end
          ul.navbar-nav
            li.nav-item
              a.nav-link(href='/dashboard') Dashboard
            li.nav-item
              a.nav-link(href='/saleslist') Saleslist
            li.nav-item
              a.nav-link(href='/salesRecords') SalesRecords
            li.nav-item
              a.nav-link.active(href='/reports') Reports
            li.nav-item
              a.nav-link.text-danger(href='/logout') Log out

    .container.my-5
      .row.justify-content-center
        .col-md-10
          .card
            h4.text-center.mb-4 Generate Reports

            form#reportFilterForm(method='GET', action='/reports/generate')
              .row
                .col-md-6
                  label.form-label(for='reportType') Report Type
                  select.form-select(name='reportType', required)
                    option(value='sales' selected=(reportType==='sales')) Sales Report
                    option(value='stock' selected=(reportType==='stock')) Stock Report

                .col-md-6
                  label.form-label(for='period') Period (for reference)
                  select.form-select(name='period')
                    option(value='daily' selected=(period==='daily')) Daily
                    option(value='weekly' selected=(period==='weekly')) Weekly
                    option(value='monthly' selected=(period==='monthly')) Monthly
                    option(value='yearly' selected=(period==='yearly')) Yearly

              .row
                .col-md-6
                  label.form-label(for='fromDate') From Date
                  input.form-control(type='date', name='fromDate', required value=fromDate)

                .col-md-6
                  label.form-label(for='toDate') To Date
                  input.form-control(type='date', name='toDate', required value=toDate)

              .d-flex.flex-column.gap-2.mt-3
                button.btn.btn-primary(type='submit') Generate Report
                if reportData && reportData.length
                  button.btn.btn-danger#generatePDF(type='button') Download PDF

            if reportData && reportData.length
              .row.g-3.mt-4
                .col-md-4
                  .summary-card
                    h6 Total Records
                    p.fw-bold.fs-4 #{reportData.length}
                .col-md-4
                  .summary-card
                    h6 Total Quantity
                    p.fw-bold.fs-4 #{totalQuantity}
                .col-md-4
                  .summary-card
                    h6 Grand Total Amount
                    p.fw-bold.fs-4 #{totalAmount.toLocaleString()} Shs

            if reportData && reportData.length && reportType === 'sales'
              .mt-4
                h5.text-center.mb-3(style="color: white;") Sales Report Results
                .table-responsive
                  table#reportTable.table.table-bordered.table-striped.table-hover
                    thead.table-dark
                      tr
                        th Date
                        th Customer Name
                        th Product Name
                        th Product Type
                        th Quantity
                        th Selling Price
                        th Total Amount
                    tbody
                      each record in reportData
                        tr
                          td= new Date(record.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
                          td= record.customerName
                          td= record.productName
                          td= record.productType
                          td= record.quantity
                          td= record.sellingPrice.toLocaleString() + ' Shs'
                          td= (record.quantity * record.sellingPrice).toLocaleString() + ' Shs'

            if reportData && reportData.length && reportType === 'stock'
              .mt-4
                h5.text-center.mb-3(style="color: white;") Stock Report Results
                .table-responsive
                  table#reportTable.table.table-bordered.table-striped.table-hover
                    thead.table-dark
                      tr
                        th Date Received
                        th Product Name
                        th Product Type
                        th Quantity
                        th Cost Price
                        th Total Value
                        th Supplier Name
                    tbody
                      each record in reportData
                        tr
                          td= new Date(record.dateReceived).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
                          td= record.productName
                          td= record.productType
                          td= record.quantity
                          td= record.costPrice.toLocaleString() + ' Shs'
                          td= (record.quantity * record.costPrice).toLocaleString() + ' Shs'
                          td= record.supplierName

            if reportData && reportData.length === 0
              .alert.alert-info.mt-4.text-center
                strong No records found!
                p No #{reportType === 'sales' ? 'sales' : 'stock'} records exist for the selected date range (#{fromDate} to #{toDate}).

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
    script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js")
    script.
      const pdfButton = document.getElementById('generatePDF');
      if (pdfButton) {
        pdfButton.addEventListener('click', function() {
          const jsPDF = window.jspdf.jsPDF;
          const reportTypeElement = document.querySelector('select[name="reportType"]');
          const fromDateElement = document.querySelector('input[name="fromDate"]');
          const toDateElement = document.querySelector('input[name="toDate"]');
          const reportType = reportTypeElement ? reportTypeElement.value : 'sales';
          const fromDate = fromDateElement ? fromDateElement.value : '';
          const toDate = toDateElement ? toDateElement.value : '';
          const doc = new jsPDF('landscape');
          doc.setFontSize(18);
          doc.setFont(undefined, 'bold');
          doc.text('MWF ' + (reportType === 'sales' ? 'Sales' : 'Stock') + ' Report', 20, 20);
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Period: ' + fromDate + ' to ' + toDate, 20, 28);
          const table = document.getElementById('reportTable');
          if (table) {
            doc.autoTable({ 
              html: table, 
              startY: 35,
              styles: { fontSize: 8, cellPadding: 2 },
              headStyles: { fillColor: [52, 58, 64], fontStyle: 'bold' },
              alternateRowStyles: { fillColor: [245, 245, 245] }
            });
          }
          const summaryCards = document.querySelectorAll('.summary-card p');
          let totalRecords = 0;
          let totalQuantity = 0;
          let totalAmount = 0;
          if (summaryCards.length >= 3) {
            totalRecords = summaryCards[0].textContent.trim();
            totalQuantity = summaryCards[1].textContent.trim();
            totalAmount = summaryCards[2].textContent.replace(' Shs', '').trim();
          }
          doc.setFontSize(12);
          doc.setFont(undefined, 'bold');
          const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 45;
          doc.text('SUMMARY', 20, finalY);
          doc.setFont(undefined, 'normal');
          doc.text('Total Records: ' + totalRecords, 20, finalY + 7);
          doc.text('Total Quantity: ' + totalQuantity, 20, finalY + 14);
          doc.setFont(undefined, 'bold');
          doc.text('Grand Total: ' + totalAmount + ' Shs', 20, finalY + 21);
          doc.setFontSize(8);
          doc.setFont(undefined, 'italic');
          const timestamp = new Date().toLocaleString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          doc.text('Generated on: ' + timestamp, 20, finalY + 30);
          doc.save('MWF_' + reportType + '_Report_' + fromDate + '_to_' + toDate + '.pdf');
        });
      }