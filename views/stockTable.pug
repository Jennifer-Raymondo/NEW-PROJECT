extends layout

block navbar
  nav.navbar.navbar-expand-lg.navbar-dark.bg-dark.py-2
    .container-fluid
      a.navbar-brand(href='/dashboard') MWF
      button.navbar-toggler(type='button', data-bs-toggle='collapse', data-bs-target='#navbarNav', aria-controls='navbarNav', aria-expanded='false', aria-label='Toggle navigation')
        span.navbar-toggler-icon
      #navbarNav.collapse.navbar-collapse.justify-content-end
        ul.navbar-nav.ms-auto
          li.nav-item
            a.nav-link(href='/dashboard') Dashboard
          li.nav-item
            a.nav-link(href='/stock') Stock
          li.nav-item
            a.nav-link(href='/stocklist') Stocklist
          li.nav-item
            a.nav-link(href='/finishedProducts') Products
          li.nav-item
            a.nav-link.text-danger(href='/logout') Log out

block content
  .container.mt-5
    h2.text-center.mb-4 Stock Records

    .d-flex.justify-content-end.mt-3
      a.btn.btn-success(href='/stock') + Add New Stock
    br

    .table-responsive
      table.table.table-striped.table-bordered.table-hover
        thead.table-dark
          tr
            th Product Name
            th Product Type
            th Supplier Name
            th Quantity
            th Cost Price (UGX)
            th Date Received
            th Quality
            th Action
        tbody
          if stocks && stocks.length
            each stock in stocks
              tr
                td #{stock.productName}
                td #{stock.productType}
                td #{stock.supplierName}
                td #{stock.quantity}
                td #{stock.costPrice}
                td #{stock.dateReceived ? (new Date(stock.dateReceived)).toLocaleDateString() : ''}
                td #{stock.quality}
                td.d-flex.gap-2
                  a.btn.btn-sm.btn-warning(href=`/stock/edit/${stock._id}`) Edit
                  form(action=`/stock/delete/${stock._id}` method='post')
                    button.btn.btn-sm.btn-danger(type='submit') Delete
          else
            tr
              td(colspan='8').text-center.text-muted No stock records found.

  // JS Scripts
  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')
  script(src="https://cdn.jsdelivr.net/npm/sweetalert2@11")
  script.
    // Confirmation popup before deleting stock
    document.querySelectorAll('form[action^="/stock/delete/"]').forEach(form => {
      form.addEventListener('submit', function (e) {
        e.preventDefault(); // Stop normal form submit

        Swal.fire({
          title: 'Are you sure?',
          text: "This stock record will be permanently deleted!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: 'burlywood',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit(); // Proceed only if confirmed
          }
        });
      });
    });

    // Show success popup after deletion
    if (window.location.search.includes('deleted=true')) {
      Swal.fire({
        title: 'Deleted!',
        text: 'The stock record was successfully deleted.',
        icon: 'success',
        confirmButtonColor: '#3085d6'
      });
    }
